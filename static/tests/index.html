<!DOCTYPE html>
<html>
    <head>
        <title>Testing the bench</title>
        <script src="/js/bench.js"></script>
        <script>
            //console = {log: function(){}};
            var b = bench(100, 20, 20, 50);
            //b.group("*calibration*", new Function);
            b.register(
"\
function test(){}\n\
var nil = [];\n\
\n\
this.group(\n\
    function fn(x){ return test(x); },\n\
    function fnCall(x){ return test.call(nil, x); },\n\
    function fnApply(x){ return test.apply(nil, arguments); }\n\
);\n\
"
            );
            b.on('testBegin',  function(test){ console.log('test begin with ' + test.groups.length + ' groups'); });
            b.on('testEnd',    function(test){ console.log('test end'); });
            b.on('groupBegin', function(test, ngroup){ console.log('group begin: ' + test.groups[ngroup] + ' with ' + test.unitDict[test.groups[ngroup]].length + ' units'); });
            b.on('groupEnd',   function(test, ngroup){ console.log('group end: ' + test.groups[ngroup]); });
            b.on('calBegin',   function(test, ngroup, nunit){ console.log('calibration begin: ' + test.groups[ngroup] + ' - ' + test.unitDict[test.groups[ngroup]][nunit].name); });
            b.on('calEnd',     function(test, ngroup, nunit){ console.log('calibration end: ' + test.groups[ngroup] + ' - ' + test.unitDict[test.groups[ngroup]][nunit].name); });
            b.on('unitEnd',    function(test, ngroup, nunit){ console.log('unit end: ' + test.groups[ngroup] + ' - ' + test.unitDict[test.groups[ngroup]][nunit].name); });
            //b.on('pointBegin', function(test, ngroup, nunit){ console.log('point begin: ' + test.groups[ngroup] + ' - ' + test.unitDict[test.groups[ngroup]][nunit].name); });
            //b.on('pointEnd',   function(test, ngroup, nunit){ console.log('point end: ' + test.groups[ngroup] + ' - ' + test.unitDict[test.groups[ngroup]][nunit].name); });

            b.on('unitBegin', function(test, ngroup, nunit){
                var name = test.groups[ngroup], unit = test.unitDict[name][nunit];
                console.log('unit begin: ' + name + ' - ' +
                    unit.name + ' (each point repeats unit ' +
                    unit.reps + ' times taking ~' +
                    unit.ms + 'ms)');
            });

            b.on("testEnd", function(test){
                var parent = document.getElementById("log");
                parent.innerHTML = "";
                for(var i = 0; i < test.groups.length; ++i){
                    var name = test.groups[i],
                        units = test.unitDict[name],
                        node = document.createElement("h2");
                    node.innerHTML = name;
                    parent.appendChild(node);
                    for(var j = 0; j < units.length; ++j){
                        var unit = units[j];
                        node = document.createElement("h3");
                        node.innerHTML = unit.name;
                        parent.appendChild(node);
                        node = document.createElement("p");
                        node.innerHTML = unit.stats.length + " points, each averages " + unit.reps + " measurements.";
                        parent.appendChild(node);
                        //var rmean = i ? resampledMeanDiff(unit.stats, test.unitDict[test.groups[0]][0].stats, 1000) : resampledMean(unit.stats, 1000);
                        var rmean = resampledMean(unit.stats, 1000);
                        var avg = 0;
                        for(var k = 0; k < unit.stats.length; ++k){
                            avg += unit.stats[k] / unit.stats.length;
                        }
                        node = document.createElement("p");
                        node.innerHTML = "mean: " + rmean + "ms, avg: " + avg + "ms, bias: " + (avg - rmean) + "ms";
                        parent.appendChild(node);
                    }
                }
            });

            function mean(a){
                var len = a.length, m = 0;
                for(var i = 0; i < len; ++i){
                    m += a[Math.floor(Math.random() * len)] / len;
                }
                return m;
            }

            function meanDiff(a, b){
                return mean(a) - mean(b);
            }

            function resampledMean(a, n){
                var m = 0;
                for(var i = 0; i < n; ++i){
                    m += mean(a) / n;
                }
                return m;
            }

            function resampledMeanDiff(a, b, n){
                var m = 0;
                for(var i = 0; i < n; ++i){
                    m += meanDiff(a, b) / n;
                }
                return m;
            }

            function onLoad(){
                b.run();
            }
        </script>
    </head>
    <body>
        <h1>Testing the bench</h1>
        <p><button onclick="onLoad()">Run</button></p>
        <div id="log">See the console output.</div>
    </body>
</html>